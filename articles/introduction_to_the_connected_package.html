<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to the 'connected' package • connected</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the 'connected' package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">connected</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction_to_the_connected_package.html">Introduction to the 'connected' package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to the 'connected' package</h1>
                        <h4 data-toc-skip class="author">Kevin
Wright</h4>
            
      

      <div class="d-none name"><code>introduction_to_the_connected_package.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>connected</code> package arose from our experience
analyzing data with linear models and linear mixed models. Sometimes
those models failed to converge, and when the reason for the convergence
was investigated, it sometimes turned out to be either that that the
data was not connected or else was weakly connected.</p>
<p>The main functions in the <code>connected</code> package are:</p>
<ul>
<li><code><a href="../reference/con_check.html">con_check()</a></code></li>
<li><code><a href="../reference/con_view.html">con_view()</a></code></li>
<li><code><a href="../reference/con_filter.html">con_filter()</a></code></li>
</ul>
</div>
<div class="section level2">
<h2 id="visualizing-two-way-connectedness-with-con_view">Visualizing two-way connectedness with <code>con_view()</code><a class="anchor" aria-label="anchor" href="#visualizing-two-way-connectedness-with-con_view"></a>
</h2>
<p>To illustrate the idea of connectedness, consider the following
example data from Fernando et al. (1983) that is inspired by the cattle
industry</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/connected/">connected</a></span><span class="op">)</span></span>
<span><span class="va">data_fernando</span></span>
<span><span class="co">#&gt;   gen herd</span></span>
<span><span class="co">#&gt; 1  G2   H1</span></span>
<span><span class="co">#&gt; 2  G1   H1</span></span>
<span><span class="co">#&gt; 3  G1   H3</span></span>
<span><span class="co">#&gt; 4  G6   H3</span></span>
<span><span class="co">#&gt; 5  G3   H2</span></span>
<span><span class="co">#&gt; 6  G4   H2</span></span>
<span><span class="co">#&gt; 7  G5   H2</span></span>
<span><span class="co">#&gt; 8  G5   H4</span></span>
<span><span class="co">#&gt; 9  G7   H4</span></span></code></pre></div>
<p>There are 2 factors: genotype and herd. Each row represents one
animal in a herd. Although this data does not have a response variable,
we can simulate a response variable and then see if the data could be
analyzed by a linear model with the 2 factors.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">data_fernando</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">data_fernando</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_fernando</span><span class="op">)</span>, mean<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">gen</span> <span class="op">+</span> <span class="va">herd</span>, data<span class="op">=</span><span class="va">data_fernando</span><span class="op">)</span></span>
<span><span class="va">m1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ gen + herd, data = data_fernando)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)        genG2        genG3        genG4        genG5        genG6  </span></span>
<span><span class="co">#&gt;     99.4353       1.9357      -0.6372      -1.1476       0.4700       0.2697  </span></span>
<span><span class="co">#&gt;       genG7       herdH2       herdH3       herdH4  </span></span>
<span><span class="co">#&gt;      2.5831       1.6062       0.9278           NA</span></span></code></pre></div>
<p>While there are no warnings, looking at the model coefficients shows
that the estimate of the effect for herd <code>H4</code> is not
estimable. This happens because the model matrix is not full rank. To
understand why, look at the following graphical view of the data in a
levelplot:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">data_fernando</span>, <span class="va">y</span> <span class="op">~</span> <span class="va">gen</span> <span class="op">*</span> <span class="va">herd</span>, main<span class="op">=</span><span class="st">"data_fernando"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in con_view(data_fernando, y ~ gen * herd, main = "data_fernando"):</span></span>
<span><span class="co">#&gt; There are 2 groups</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-3-1.png" width="384" style="display: block; margin: auto;"></p>
<p>The <code><a href="../reference/con_view.html">con_view()</a></code> function does the following:</p>
<ul>
<li>Plots a levelplot/heatmap of the two factors, with the cell color
corresponding to the value of the response variable.</li>
<li>Counts the number of cells in each row and puts this count on the
right axis. Column counts are added along the top axis.</li>
<li>Sorts the rows and columns (by default) according to clustering of
the <em>incidence</em> matrix based on the presence/absence of data in
each cell of the graph.</li>
<li>Checks for connectivity of the two factors. If the observations are
NOT connected, then cells belonging to the same connected subset are
identified with a number.</li>
</ul>
<p>This graphical view shows us that herds <code>H1</code> and
<code>H3</code> have no levels of the genotype factor that are in common
with herds <code>H2</code> and <code>H4</code>, so it makes sense that
not all herd effects will be estimable.</p>
</div>
<div class="section level2">
<h2 id="checking-multi-way-connectedness-with-con_check">Checking multi-way connectedness with <code>con_check()</code><a class="anchor" aria-label="anchor" href="#checking-multi-way-connectedness-with-con_check"></a>
</h2>
<p>The two-way heatmaps in the previous section are very useful to
understand connectedness of two factors, but what if there are more than
two factors?</p>
<p>Here is a small example dataset from Eccleston and Russell (1975)
with three factors that can represent a 4x4 row-column experiment with a
treatment for each cell.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_eccleston</span></span>
<span><span class="co">#&gt;    row col trt</span></span>
<span><span class="co">#&gt; 1    1   1  A1</span></span>
<span><span class="co">#&gt; 2    1   2  B2</span></span>
<span><span class="co">#&gt; 3    1   3  E5</span></span>
<span><span class="co">#&gt; 4    1   4  F6</span></span>
<span><span class="co">#&gt; 5    2   1  C3</span></span>
<span><span class="co">#&gt; 6    2   2  D4</span></span>
<span><span class="co">#&gt; 7    2   3  G7</span></span>
<span><span class="co">#&gt; 8    2   4  H8</span></span>
<span><span class="co">#&gt; 9    3   1  H8</span></span>
<span><span class="co">#&gt; 10   3   2  F6</span></span>
<span><span class="co">#&gt; 11   3   3  A1</span></span>
<span><span class="co">#&gt; 12   3   4  C3</span></span>
<span><span class="co">#&gt; 13   4   1  G7</span></span>
<span><span class="co">#&gt; 14   4   2  E5</span></span>
<span><span class="co">#&gt; 15   4   3  B2</span></span>
<span><span class="co">#&gt; 16   4   4  D4</span></span></code></pre></div>
<p>The treatment codes have both a letter and a number only because both
have been used in previously-published scientific papers. Each treatment
letter corresponds with one number and vice versa. Re-arranging the
treatments into the field layout of rows and columns is useful:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## library(reshape2)</span></span>
<span><span class="co">## acast(data_eccleston, row~col, value.var='trt')</span></span>
<span><span class="co">##    1  2  3  4 </span></span>
<span><span class="co">##  1 A1 B2 E5 F6</span></span>
<span><span class="co">##  2 C3 D4 G7 H8</span></span>
<span><span class="co">##  3 H8 F6 A1 C3</span></span>
<span><span class="co">##  4 G7 E5 B2 D4</span></span></code></pre></div>
<p>The 4x4 grid is completely filled, so the row and column factors are
obviously connected. With a little bit of study, it can be seen that the
columns are also connected via the treatments. For example treatment
<code>A1</code> appears in columns 1 &amp; 3, treatment <code>B2</code>
connects columns 3 &amp; 2, <code>D4</code> connects columns 2 &amp; 4,
and <code>C3</code> connects columns 4 &amp; 1. The connection of
treatments and columns can be checked formally with the
<code><a href="../reference/con_check.html">con_check()</a></code> function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_check.html">con_check</a></span><span class="op">(</span><span class="va">data_eccleston</span>, <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt; Levels: 1</span></span></code></pre></div>
<p>The vector of <code>1</code>s returned means that all observations of
the dataframe are connected in group 1.</p>
<p>Similarly, the rows are also connected via the treatments.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_check.html">con_check</a></span><span class="op">(</span><span class="va">data_eccleston</span>, <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">row</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt; Levels: 1</span></span></code></pre></div>
<p>However, if all 3 factors are considered at the same time, they are
completely disconnected with each observation belonging to a separate
group.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_check.html">con_check</a></span><span class="op">(</span><span class="va">data_eccleston</span>, <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">row</span> <span class="op">+</span> <span class="va">col</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 16 1  2  3  4  5  6  7  8  9  10 11 12 13 14 15</span></span>
<span><span class="co">#&gt; Levels: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</span></span></code></pre></div>
<p>If we attempted to fit a linear model using all 3 factors as
predictors, there would be problems with estimability.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">data_eccleston</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">data_eccleston</span>,</span>
<span>                            y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_eccleston</span><span class="op">)</span>, mean<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">row</span> <span class="op">+</span> <span class="va">col</span>, data<span class="op">=</span><span class="va">data_eccleston</span><span class="op">)</span></span>
<span><span class="va">m1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ trt + row + col, data = data_eccleston)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)        trtB2        trtC3        trtD4        trtE5        trtF6  </span></span>
<span><span class="co">#&gt;   100.78962     -0.18428     -0.11760      0.30450      0.20690     -0.72684  </span></span>
<span><span class="co">#&gt;       trtG7        trtH8         row2         row3         row4         col2  </span></span>
<span><span class="co">#&gt;    -0.22508     -0.50118     -0.06302      1.09660     -0.94338     -0.96532  </span></span>
<span><span class="co">#&gt;        col3         col4  </span></span>
<span><span class="co">#&gt;          NA      0.31332</span></span></code></pre></div>
<p>Another way to examine the stability of the model is to look at the
reciprocal condition number of the model matrix, which is less than the
machine precision, so it is numerically singular.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rcond-methods.html" class="external-link">rcond</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.311474e-17</span></span>
<span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span></span>
<span><span class="co">#&gt; [1] 2.220446e-16</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="improving-connectedness-with-con_filter">Improving connectedness with <code>con_filter()</code><a class="anchor" aria-label="anchor" href="#improving-connectedness-with-con_filter"></a>
</h2>
<p>Sometimes two factors of a dataframe can be weakly connected and we
might want to remove those weak connections.</p>
<div class="section level3">
<h3 id="example-1">Example 1<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<p>We construct a small example and use the <code>tabyl</code> function
to display the data in a two-way table.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>gen<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>,<span class="st">"G1"</span>,<span class="st">"G1"</span>,<span class="st">"G1"</span>, <span class="st">"G2"</span>,<span class="st">"G2"</span>,<span class="st">"G2"</span>, <span class="st">"G3"</span><span class="op">)</span>,</span>
<span>                  state<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>,<span class="st">"S2"</span>,<span class="st">"S3"</span>,<span class="st">"S4"</span>, <span class="st">"S1"</span>,<span class="st">"S2"</span>,<span class="st">"S4"</span>, <span class="st">"S1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor" class="external-link">janitor</a></span><span class="op">)</span> <span class="co"># For tabyl</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'janitor'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     chisq.test, fisher.test</span></span>
<span><span class="va">tab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">state</span>,<span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt;  state G1 G2 G3</span></span>
<span><span class="co">#&gt;     S1  1  1  1</span></span>
<span><span class="co">#&gt;     S2  1  1  0</span></span>
<span><span class="co">#&gt;     S3  1  0  0</span></span>
<span><span class="co">#&gt;     S4  1  1  0</span></span></code></pre></div>
<p>In the two-way table it is easy to see that the <code>gen</code>
factor level <code>G3</code> has only 1 cell connecting to the
<code>state</code> factor. We might want to eliminate the column with
genotype <code>G3</code>. The ordinary way to do this would be to use
one of these approaches:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">tab</span>, <span class="va">gen</span> <span class="op">!=</span> <span class="st">"G3"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">state</span>,<span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt;  state G1 G2</span></span>
<span><span class="co">#&gt;     S1  1  1</span></span>
<span><span class="co">#&gt;     S2  1  1</span></span>
<span><span class="co">#&gt;     S3  1  0</span></span>
<span><span class="co">#&gt;     S4  1  1</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tab</span>, <span class="va">gen</span> <span class="op">!=</span> <span class="st">"G3"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">state</span>,<span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt;  state G1 G2</span></span>
<span><span class="co">#&gt;     S1  1  1</span></span>
<span><span class="co">#&gt;     S2  1  1</span></span>
<span><span class="co">#&gt;     S3  1  0</span></span>
<span><span class="co">#&gt;     S4  1  1</span></span></code></pre></div>
<p>We generalize the idea of filtering to a new two-way filtering using
the <code><a href="../reference/con_filter.html">con_filter()</a></code> function. The easiest way to think about
this function is with a two-way table as shown above, and then to define
a threshold for the minimum number of connections between two factors.
For example, we might decide to only keep a level of <code>gen</code> if
it appears in at least 2 <code>state</code>s. We use a formula syntax
for this.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read this as "2 state per gen"</span></span>
<span><span class="va">tab2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">tab</span>, <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">state</span> <span class="op">/</span> <span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 1 of 3 levels of gen:</span></span>
<span><span class="co">#&gt; [1] "G3"</span></span>
<span><span class="co">#&gt; Deleted 1 of 8 rows of data.</span></span>
<span><span class="co">#&gt; Warning in con_filter(tab, ~2 * state/gen): Some state have only 1 gen.</span></span>
<span><span class="va">tab2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">state</span>,<span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt;  state G1 G2</span></span>
<span><span class="co">#&gt;     S1  1  1</span></span>
<span><span class="co">#&gt;     S2  1  1</span></span>
<span><span class="co">#&gt;     S3  1  0</span></span>
<span><span class="co">#&gt;     S4  1  1</span></span></code></pre></div>
<p>By default, the <code><a href="../reference/con_filter.html">con_filter()</a></code> function provides a bit of
diagnostic information.</p>
<p>After the filtering, notice that <code>state</code> <code>S3</code>
only appears once and we decide that we only want to keep an individual
<code>state</code> if it has at least 2 <code>gen</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">tab2</span>, <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">gen</span> <span class="op">/</span> <span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 1 of 4 levels of state:</span></span>
<span><span class="co">#&gt; [1] "S3"</span></span>
<span><span class="co">#&gt; Deleted 1 of 7 rows of data.</span></span>
<span><span class="co">#&gt;  state G1 G2</span></span>
<span><span class="co">#&gt;     S1  1  1</span></span>
<span><span class="co">#&gt;     S2  1  1</span></span>
<span><span class="co">#&gt;     S4  1  1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-2---missing-response-values">Example 2 - Missing response values<a class="anchor" aria-label="anchor" href="#example-2---missing-response-values"></a>
</h3>
<p>The R dataset <code>OrchardSprays</code> is an example of a Latin
Square experiment with 8 rows, 8 columns, and 8 treatments. Suppose that
during the experiment, half of the response variable data was lost. We
simulate that:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span>  <span class="va">orch</span> <span class="op">&lt;-</span> <span class="va">OrchardSprays</span></span>
<span>  <span class="va">orch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">orch</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">.5</span> , <span class="st">"decrease"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">orch</span><span class="op">)</span></span>
<span><span class="co">#&gt;   decrease rowpos colpos treatment</span></span>
<span><span class="co">#&gt; 1       NA      1      1         D</span></span>
<span><span class="co">#&gt; 2       NA      2      1         E</span></span>
<span><span class="co">#&gt; 3        8      3      1         B</span></span>
<span><span class="co">#&gt; 4       NA      4      1         H</span></span>
<span><span class="co">#&gt; 5       NA      5      1         G</span></span>
<span><span class="co">#&gt; 6       NA      6      1         F</span></span></code></pre></div>
<p>In order to visualize the combinations of rows and columns that still
have data, we have to remove the missing observations before
constructing a table of cell counts:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">orch</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">decrease</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">rowpos</span>, <span class="va">colpos</span><span class="op">)</span> </span>
<span><span class="co">#&gt;  rowpos 1 2 3 4 5 6 7 8</span></span>
<span><span class="co">#&gt;       1 0 0 0 1 1 1 0 0</span></span>
<span><span class="co">#&gt;       2 0 0 1 0 0 1 0 1</span></span>
<span><span class="co">#&gt;       3 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;       4 0 0 0 0 0 0 1 0</span></span>
<span><span class="co">#&gt;       5 0 0 0 1 1 1 1 0</span></span>
<span><span class="co">#&gt;       6 0 1 1 0 1 0 0 0</span></span>
<span><span class="co">#&gt;       7 0 1 0 0 0 0 1 0</span></span>
<span><span class="co">#&gt;       8 1 0 0 0 0 0 0 0</span></span></code></pre></div>
<p>The <code><a href="../reference/con_filter.html">con_filter()</a></code> formula syntax can include a response
variable. If the response variable is specified, the data is first
filtered to remove missing values in the response, and then the two-way
filtering is performed. Suppose we want to have at least 2 observed
values of <code>decrease</code> in each row and column</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read: decrease has at least 2 colpos per rowps</span></span>
<span><span class="va">orch2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">orch</span>, <span class="va">decrease</span> <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">colpos</span> <span class="op">/</span> <span class="va">rowpos</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 2 of 8 levels of rowpos:</span></span>
<span><span class="co">#&gt; [1] "4" "8"</span></span>
<span><span class="co">#&gt; Deleted 2 of 25 rows of data.</span></span>
<span><span class="co">#&gt; Warning in con_filter(orch, decrease ~ 2 * colpos/rowpos): Some colpos have</span></span>
<span><span class="co">#&gt; only 1 rowpos.</span></span>
<span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">orch2</span>, <span class="va">rowpos</span>, <span class="va">colpos</span><span class="op">)</span> <span class="co"># Column 1 has only 1 observation</span></span>
<span><span class="co">#&gt;  rowpos 1 2 3 4 5 6 7 8</span></span>
<span><span class="co">#&gt;       1 0 0 0 1 1 1 0 0</span></span>
<span><span class="co">#&gt;       2 0 0 1 0 0 1 0 1</span></span>
<span><span class="co">#&gt;       3 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;       5 0 0 0 1 1 1 1 0</span></span>
<span><span class="co">#&gt;       6 0 1 1 0 1 0 0 0</span></span>
<span><span class="co">#&gt;       7 0 1 0 0 0 0 1 0</span></span>
<span></span>
<span><span class="co"># Read: decrease has at least 2 rowpos per colpos</span></span>
<span><span class="va">orch2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">orch2</span>, <span class="va">decrease</span> <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">rowpos</span> <span class="op">/</span> <span class="va">colpos</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 1 of 8 levels of colpos:</span></span>
<span><span class="co">#&gt; [1] "1"</span></span>
<span><span class="co">#&gt; Deleted 1 of 23 rows of data.</span></span>
<span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">orch2</span>, <span class="va">rowpos</span>, <span class="va">colpos</span><span class="op">)</span></span>
<span><span class="co">#&gt;  rowpos 2 3 4 5 6 7 8</span></span>
<span><span class="co">#&gt;       1 0 0 1 1 1 0 0</span></span>
<span><span class="co">#&gt;       2 0 1 0 0 1 0 1</span></span>
<span><span class="co">#&gt;       3 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;       5 0 0 1 1 1 1 0</span></span>
<span><span class="co">#&gt;       6 1 1 0 1 0 0 0</span></span>
<span><span class="co">#&gt;       7 1 0 0 0 0 1 0</span></span></code></pre></div>
<p>The desired result has been achieved.</p>
</div>
<div class="section level3">
<h3 id="example-3---concatenating-two-factors">Example 3 - Concatenating two factors<a class="anchor" aria-label="anchor" href="#example-3---concatenating-two-factors"></a>
</h3>
<p>Sometimes you might want to combine two factors together before
filtering. Consider the following example with factor for genotype
<code>gen</code>, <code>state</code>, and <code>year</code>. We simulate
some random response data.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/connected/">connected</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor" class="external-link">janitor</a></span><span class="op">)</span></span>
<span><span class="va">test1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"IA"</span>, <span class="st">"2020"</span>, <span class="co"># gen has 1 state, 1 yr,</span></span>
<span>                   <span class="st">"G2"</span>, <span class="st">"IA"</span>, <span class="st">"2020"</span>, <span class="co"># gen has 1 state, 2 yr</span></span>
<span>                   <span class="st">"G2"</span>, <span class="st">"IA"</span>, <span class="st">"2021"</span>,</span>
<span>                   <span class="st">"G3"</span>, <span class="st">"NE"</span>, <span class="st">"2020"</span>, <span class="co"># 2 states, 1 yr</span></span>
<span>                   <span class="st">"G3"</span>, <span class="st">"IA"</span>, <span class="st">"2020"</span>,</span>
<span>                   <span class="st">"G4"</span>, <span class="st">"KS"</span>, <span class="st">"2020"</span>, <span class="co"># state has 1 gen, 1 yr</span></span>
<span>                   <span class="st">"G5"</span>, <span class="st">"MO"</span>, <span class="st">"2020"</span>, <span class="co"># state has 1 gen, 2yr</span></span>
<span>                   <span class="st">"G5"</span>, <span class="st">"MO"</span>, <span class="st">"2021"</span>,</span>
<span>                   <span class="st">"G6"</span>, <span class="st">"IL"</span>, <span class="st">"2020"</span>, <span class="co"># state has 2 gen, 1yr</span></span>
<span>                   <span class="st">"G7"</span>, <span class="st">"IL"</span>, <span class="st">"2020"</span>,</span>
<span>                   <span class="st">"G8"</span>, <span class="st">"AR"</span>, <span class="st">"2019"</span>, <span class="co"># year has 1 gen 1 state</span></span>
<span>                   <span class="st">"G9"</span>, <span class="st">"IN"</span>, <span class="st">"2018"</span>, <span class="co"># year has 1 gen, 2 state</span></span>
<span>                   <span class="st">"G9"</span>, <span class="st">"OH"</span>, <span class="st">"2018"</span>,</span>
<span>                   <span class="st">"G10"</span>, <span class="st">"MN"</span>, <span class="st">"2017"</span>, <span class="co"># year has 2 gen, 1 state</span></span>
<span>                   <span class="st">"G11"</span>, <span class="st">"MN"</span>, <span class="st">"2017"</span>,</span>
<span>                   <span class="st">"G12"</span>, <span class="st">"MD"</span>, <span class="st">"2010"</span>, <span class="co"># gen has 2 state, 2 yr, 2 reps</span></span>
<span>                   <span class="st">"G12"</span>, <span class="st">"MD"</span>, <span class="st">"2010"</span>,</span>
<span>                   <span class="st">"G12"</span>, <span class="st">"GA"</span>, <span class="st">"2011"</span>,</span>
<span>                   <span class="st">"G12"</span>, <span class="st">"GA"</span>, <span class="st">"2011"</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">TRUE</span>, ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">test1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">test1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">test1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gen"</span>,<span class="st">"state"</span>,<span class="st">"year"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">test1</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">test1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">test1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   gen state year    y</span></span>
<span><span class="co">#&gt; 1  G1    IA 2020 0.91</span></span>
<span><span class="co">#&gt; 2  G2    IA 2020 0.94</span></span>
<span><span class="co">#&gt; 3  G2    IA 2021 0.29</span></span>
<span><span class="co">#&gt; 4  G3    NE 2020 0.83</span></span>
<span><span class="co">#&gt; 5  G3    IA 2020 0.64</span></span>
<span><span class="co">#&gt; 6  G4    KS 2020 0.52</span></span></code></pre></div>
<p>As shown in the previous sections, we can check/filter the
<code>gen:state</code> and <code>gen:year</code> factors, but perhaps we
are interested in fitting a model with the three-way interaction
<code>gen:state:year</code>. One way to trim this type of data is to
combine the <code>state:year</code> interaction into a single factor and
then count the number <code>gen</code>otypes in that new factor. The
<code><a href="../reference/con_filter.html">con_filter()</a></code> function can perform this concatenation of two
factors automatically using the <code>:</code> operator.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">test1</span>, <span class="va">y</span> <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">gen</span> <span class="op">/</span> <span class="va">state</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span>stateyr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">state</span>,<span class="st">"_"</span>,<span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://sfirke.github.io/janitor/reference/tabyl.html" class="external-link">tabyl</a></span><span class="op">(</span><span class="va">gen</span>,<span class="va">stateyr</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 10 of 13 levels of state:year:</span></span>
<span><span class="co">#&gt;  [1] "AR2019" "GA2011" "IA2021" "IN2018" "KS2020" "MD2010" "MO2020" "MO2021"</span></span>
<span><span class="co">#&gt;  [9] "NE2020" "OH2018"</span></span>
<span><span class="co">#&gt; Deleted 12 of 19 rows of data.</span></span>
<span><span class="co">#&gt; Warning in con_filter(test1, y ~ 2 * gen/state:year): Some gen have only 1</span></span>
<span><span class="co">#&gt; state:year.</span></span>
<span><span class="co">#&gt;  gen IA_2020 IL_2020 MN_2017</span></span>
<span><span class="co">#&gt;   G1       1       0       0</span></span>
<span><span class="co">#&gt;  G10       0       0       1</span></span>
<span><span class="co">#&gt;  G11       0       0       1</span></span>
<span><span class="co">#&gt;   G2       1       0       0</span></span>
<span><span class="co">#&gt;   G3       1       0       0</span></span>
<span><span class="co">#&gt;   G6       0       1       0</span></span>
<span><span class="co">#&gt;   G7       0       1       0</span></span></code></pre></div>
<p>Looking at the results, we can see that each column is one level of
the new <code>state:year</code> factor and that each column has at least
2 <code>gen</code>otypes, which is what we asked for.</p>
<p>If we ever want to see what data is dropped during the filtering
process, the <code>returndropped=TRUE</code> argument can be used.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">test1</span>, <span class="va">y</span> <span class="op">~</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">gen</span> <span class="op">/</span> <span class="va">state</span><span class="op">:</span><span class="va">year</span>, returndropped<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 10 of 13 levels of state:year:</span></span>
<span><span class="co">#&gt;  [1] "AR2019" "GA2011" "IA2021" "IN2018" "KS2020" "MD2010" "MO2020" "MO2021"</span></span>
<span><span class="co">#&gt;  [9] "NE2020" "OH2018"</span></span>
<span><span class="co">#&gt; Deleted 7 of 19 rows of data.</span></span>
<span><span class="co">#&gt; Warning in con_filter(test1, y ~ 2 * gen/state:year, returndropped = TRUE):</span></span>
<span><span class="co">#&gt; Some gen have only 1 state:year.</span></span>
<span><span class="co">#&gt;    gen state year    y</span></span>
<span><span class="co">#&gt; 3   G2    IA 2021 0.29</span></span>
<span><span class="co">#&gt; 4   G3    NE 2020 0.83</span></span>
<span><span class="co">#&gt; 6   G4    KS 2020 0.52</span></span>
<span><span class="co">#&gt; 7   G5    MO 2020 0.74</span></span>
<span><span class="co">#&gt; 8   G5    MO 2021 0.13</span></span>
<span><span class="co">#&gt; 11  G8    AR 2019 0.46</span></span>
<span><span class="co">#&gt; 12  G9    IN 2018 0.72</span></span>
<span><span class="co">#&gt; 13  G9    OH 2018 0.93</span></span>
<span><span class="co">#&gt; 16 G12    MD 2010 0.94</span></span>
<span><span class="co">#&gt; 17 G12    MD 2010 0.98</span></span>
<span><span class="co">#&gt; 18 G12    GA 2011 0.12</span></span>
<span><span class="co">#&gt; 19 G12    GA 2011 0.47</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-4-case-study-estimating-variance-components">Example 4: Case study: Estimating variance components<a class="anchor" aria-label="anchor" href="#example-4-case-study-estimating-variance-components"></a>
</h2>
<p>Sometimes the observations of a dataset may be connected, but some of
the factor levels may have very weak connections and it might be a good
idea to remove those weak connections. For example, in the documentation
of the <code>ASRtrials</code> package that is helpful for analysis of
genotype-by-environment data, Gezan et al. (2022) write: “In general, we
recommend that a minimum of 5 genotypes should be common between any
pair of trials.” Ultimately, you have to decide how much connection you
want between the factors.</p>
<p>The following example shows how to use the <code><a href="../reference/con_filter.html">con_filter()</a></code>
function to remove some of the weak connections between levels of
factors.</p>
<p>In plant breeding, one of the things people like to do is look at how
much of the variation in the data is explained by differences between
genotypes, years, and locations, typically abbreviated GxYxL. In order
to perform this calculation, there must be at least some locations that
are repeated across years.</p>
<p>The <code>agridat</code> package has a nice example dataset of barley
testing in Minnesota. There are 6 locations across 49 years with 235
different genotypes. There are 69090 combinations of the 3 factors, but
only 2083 combinations have yield values, so there is a great deal of
sparsity in the data. Nonetheless, we can jump right in and try to fit a
full mixed model with all combinations of the factors.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/agridat/" class="external-link">agridat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span></span>
<span><span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu">agridat</span><span class="fu">::</span><span class="va"><a href="https://kwstat.github.io/agridat/reference/minnesota.barley.yield.html" class="external-link">minnesota.barley.yield</a></span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat0</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2083</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Please upgrade the agridat package."</span><span class="op">)</span></span>
<span><span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dat0</span>, gen<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span>, site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span>, year<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="va">m0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">yield</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span>,</span>
<span>           data<span class="op">=</span><span class="va">dat0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: yield ~ (1 | gen) + (1 | site) + (1 | year) + (1 | gen:site) +  </span></span>
<span><span class="co">#&gt;     (1 | gen:year) + (1 | site:year) + (1 | gen:site:year)</span></span>
<span><span class="co">#&gt;    Data: dat0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 14327</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.17872 -0.16019 -0.00281  0.16630  1.21505 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups        Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  gen:site:year (Intercept) 24.6416  4.9640  </span></span>
<span><span class="co">#&gt;  gen:year      (Intercept)  9.8795  3.1432  </span></span>
<span><span class="co">#&gt;  gen:site      (Intercept)  0.8261  0.9089  </span></span>
<span><span class="co">#&gt;  gen           (Intercept) 45.9856  6.7813  </span></span>
<span><span class="co">#&gt;  site:year     (Intercept) 89.0064  9.4343  </span></span>
<span><span class="co">#&gt;  year          (Intercept) 38.0930  6.1719  </span></span>
<span><span class="co">#&gt;  site          (Intercept) 42.1995  6.4961  </span></span>
<span><span class="co">#&gt;  Residual                   2.6587  1.6306  </span></span>
<span><span class="co">#&gt; Number of obs: 2083, groups:  </span></span>
<span><span class="co">#&gt; gen:site:year, 2079; gen:year, 1056; gen:site, 429; gen, 235; site:year, 164; year, 49; site, 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   34.691      3.047   11.38</span></span>
<span></span>
<span><span class="co"># Note, the asreml package gives the same estimates. Not shown.</span></span>
<span><span class="co"># library(asreml)</span></span>
<span><span class="co"># m0a &lt;- asreml(yield ~ 1, data=dat0, random  = ~ gen*site*year, workspace="1GB")</span></span>
<span><span class="co"># summary(m0a)$varcomp</span></span></code></pre></div>
<p>This analysis runs without any obvious problems and may be perfectly
acceptable, but keeping in mind the comments about connectedness above,
we may want to remove some of the data through two-way filtering.</p>
<p>First, start with a two-way visualization of the sites and years.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Keep the original data in dat0 and pruned data in dat1</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="va">dat0</span></span>
<span></span>
<span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span><span class="va">site</span><span class="op">*</span><span class="va">year</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>         xlab<span class="op">=</span><span class="st">"site"</span>, ylab<span class="op">=</span><span class="st">"year"</span>, main<span class="op">=</span><span class="st">"Minnesota Barley"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-22-1.png" width="576" style="display: block; margin: auto;"></p>
<p>From 1893 through 1917, barley testing only happened at the St. Paul
site (near the University of Minnesota). Since it is not possible to
explain how much variation there is across locations when there is only
1 location, it makes sense to eliminate the data from those years with
only 1 site.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Require 2 sites per year</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span> <span class="op">~</span> <span class="fl">2</span><span class="op">*</span><span class="va">site</span><span class="op">/</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 25 of 49 levels of year:</span></span>
<span><span class="co">#&gt;  [1] "1893" "1894" "1895" "1896" "1897" "1898" "1899" "1900" "1901" "1902"</span></span>
<span><span class="co">#&gt; [11] "1903" "1904" "1905" "1906" "1907" "1908" "1909" "1910" "1911" "1912"</span></span>
<span><span class="co">#&gt; [21] "1913" "1914" "1915" "1916" "1917"</span></span>
<span><span class="co">#&gt; Deleted 731 of 2083 rows of data.</span></span>
<span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span><span class="va">gen</span><span class="op">*</span><span class="va">year</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>         xlab<span class="op">=</span><span class="st">"genotype"</span>, ylab<span class="op">=</span><span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-23-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Looking across the top, there are some <code>1</code>s that tell us
some genotypes were tested in only 1 year, so those are not really
helping to estimate variation across years and we decide to drop
those.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Require 2 year per gen</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span> <span class="fl">2</span><span class="op">*</span><span class="va">year</span><span class="op">/</span><span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 15 of 62 levels of gen:</span></span>
<span><span class="co">#&gt;  [1] "241"  "244"  "558"  "611"  "2793" "2899" "2928" "4668" "4669" "7010"</span></span>
<span><span class="co">#&gt; [11] "7011" "7012" "7013" "7014" "7015"</span></span>
<span><span class="co">#&gt; Deleted 50 of 1352 rows of data.</span></span>
<span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span><span class="va">gen</span><span class="op">*</span><span class="va">year</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"gen"</span>, ylab<span class="op">=</span><span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-24-1.png" width="576" style="display: block; margin: auto;"></p>
<p>After considering how genotypes are spread across years, we can also
look at how genotypes are spread across sites.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span><span class="va">gen</span><span class="op">*</span><span class="va">site</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"genotype"</span>, ylab<span class="op">=</span><span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-25-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Again looking at the numbers across the top axis, some genotypes are
tested in only 1 site, so we drop those.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Drop genotypes tested in only 1 site</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span> <span class="fl">2</span><span class="op">*</span><span class="va">site</span><span class="op">/</span><span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 10 of 47 levels of gen:</span></span>
<span><span class="co">#&gt;  [1] "531"  "835"  "912"  "915"  "923"  "1145" "2947" "3144" "4115" "4116"</span></span>
<span><span class="co">#&gt; Deleted 25 of 1302 rows of data.</span></span>
<span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span><span class="op">~</span><span class="va">gen</span><span class="op">*</span><span class="va">site</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"genotype"</span>, ylab<span class="op">=</span><span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-26-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We check the connectedness of each pair of factors.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span> <span class="op">~</span> <span class="va">gen</span><span class="op">*</span><span class="va">site</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"gen"</span>, ylab<span class="op">=</span><span class="st">"site"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-27-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span> <span class="op">~</span> <span class="va">gen</span><span class="op">*</span><span class="va">year</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"gen"</span>, ylab<span class="op">=</span><span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-27-2.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span> <span class="op">~</span> <span class="va">site</span><span class="op">*</span><span class="va">year</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">"site"</span>, ylab<span class="op">=</span><span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-27-3.png" width="576" style="display: block; margin: auto;"></p>
<p>The connectedness of genotype and year is still a bit weak, but the
other pairs of factors have good connections, so we try to fit the
variance components model again.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">yield</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dat1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: yield ~ (1 | gen) + (1 | site) + (1 | year) + (1 | gen:site) +  </span></span>
<span><span class="co">#&gt;     (1 | gen:year) + (1 | site:year) + (1 | gen:site:year)</span></span>
<span><span class="co">#&gt;    Data: dat1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 8434</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.12837 -0.16942 -0.00168  0.17680  1.33933 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups        Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  gen:site:year (Intercept) 21.971   4.687   </span></span>
<span><span class="co">#&gt;  gen:year      (Intercept)  3.625   1.904   </span></span>
<span><span class="co">#&gt;  gen:site      (Intercept)  1.280   1.132   </span></span>
<span><span class="co">#&gt;  site:year     (Intercept) 87.412   9.349   </span></span>
<span><span class="co">#&gt;  gen           (Intercept)  9.166   3.028   </span></span>
<span><span class="co">#&gt;  year          (Intercept) 37.412   6.117   </span></span>
<span><span class="co">#&gt;  site          (Intercept) 40.747   6.383   </span></span>
<span><span class="co">#&gt;  Residual                   2.163   1.471   </span></span>
<span><span class="co">#&gt; Number of obs: 1277, groups:  </span></span>
<span><span class="co">#&gt; gen:site:year, 1274; gen:year, 285; gen:site, 187; site:year, 139; gen, 37; year, 24; site, 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   36.751      3.055   12.03</span></span>
<span></span>
<span><span class="co"># asreml converges to the same estimated values, so lmer is just finnicky</span></span>
<span><span class="co"># m1a &lt;- asreml(yield ~ 1, data=dat1, random  = ~ gen*site*year, workspace="1GB")</span></span>
<span><span class="co"># lucid::vc(m1a)</span></span></code></pre></div>
<p>The <code>lmer</code> function fails to converge, but the variance
components look reasonable and also <code>asreml</code> is giving the
same estimates (not shown here), so there is probably some convergence
criterion for <code>lmer</code> that is not quite satisfied but is
essentially near the maximum of the likelihood. Changing the convergence
criteria might be helpful, but we can also try increasing the
connectedness of genotype and year, since we noticed that there were
some genotypes that were tested in only 2 years. Change that to require
a minimum of 3 years of testing:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Require at least 3 year per genotype</span></span>
<span><span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_filter.html">con_filter</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">yield</span> <span class="op">~</span> <span class="fl">3</span><span class="op">*</span><span class="va">year</span> <span class="op">/</span> <span class="va">gen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dropping these 3 of 37 levels of gen:</span></span>
<span><span class="co">#&gt; [1] "1189" "1478" "5673"</span></span>
<span><span class="co">#&gt; Deleted 25 of 1277 rows of data.</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">yield</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gen</span><span class="op">:</span><span class="va">site</span><span class="op">:</span><span class="va">year</span><span class="op">)</span>,</span>
<span>           data<span class="op">=</span><span class="va">dat2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: yield ~ (1 | gen) + (1 | site) + (1 | year) + (1 | gen:site) +  </span></span>
<span><span class="co">#&gt;     (1 | gen:year) + (1 | site:year) + (1 | gen:site:year)</span></span>
<span><span class="co">#&gt;    Data: dat2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 8281.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.12068 -0.16831 -0.00262  0.17584  1.32712 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups        Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  gen:site:year (Intercept) 22.114   4.703   </span></span>
<span><span class="co">#&gt;  gen:year      (Intercept)  3.696   1.923   </span></span>
<span><span class="co">#&gt;  gen:site      (Intercept)  1.272   1.128   </span></span>
<span><span class="co">#&gt;  site:year     (Intercept) 87.468   9.352   </span></span>
<span><span class="co">#&gt;  gen           (Intercept)  9.200   3.033   </span></span>
<span><span class="co">#&gt;  year          (Intercept) 37.330   6.110   </span></span>
<span><span class="co">#&gt;  site          (Intercept) 41.740   6.461   </span></span>
<span><span class="co">#&gt;  Residual                   2.156   1.468   </span></span>
<span><span class="co">#&gt; Number of obs: 1252, groups:  </span></span>
<span><span class="co">#&gt; gen:site:year, 1249; gen:year, 279; gen:site, 173; site:year, 139; gen, 34; year, 24; site, 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   36.912      3.084   11.97</span></span>
<span></span>
<span><span class="co"># asreml gives the same estimated variance parameters. Not shown.</span></span>
<span><span class="co"># m2a &lt;- asreml(yield ~ 1, data=dat2, random  = ~ gen*site*year, workspace="1GB")</span></span>
<span><span class="co"># summary(m2a)$varcomp</span></span></code></pre></div>
<p>Now <code>lmer</code> converges without any warnings.</p>
<p>We compare the estimated variance parameters from the initial model
<code>m0</code> (n=2083 observations) with model <code>m1</code> and the
final model <code>m2</code> (n=1252 observations). CAUTION: The
<code>VarCorr</code> function re-orders the terms in the output, so be
careful combining the two tables.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/lucid/" class="external-link">lucid</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html" class="external-link">VarCorr</a></span><span class="op">(</span><span class="va">m0</span><span class="op">)</span><span class="op">)</span>, <span class="va">grp</span>, <span class="va">vcov</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html" class="external-link">VarCorr</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span>, <span class="va">grp</span>, <span class="va">vcov</span><span class="op">)</span>, </span>
<span>           by<span class="op">=</span><span class="st">"grp"</span>, suffix<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".0"</span>,<span class="st">".1"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html" class="external-link">VarCorr</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span>, <span class="va">grp</span>, <span class="va">vcov</span><span class="op">)</span>, </span>
<span>           by<span class="op">=</span><span class="st">"grp"</span>, suffix<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".0"</span>,<span class="st">".2"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">lucid</span></span>
<span><span class="co">#&gt;             grp vcov.0 vcov.1  vcov</span></span>
<span><span class="co">#&gt; 1 gen:site:year 24.6    22    22.1 </span></span>
<span><span class="co">#&gt; 2      gen:year  9.88    3.63  3.7 </span></span>
<span><span class="co">#&gt; 3      gen:site  0.826   1.28  1.27</span></span>
<span><span class="co">#&gt; 4           gen 46       9.17  9.2 </span></span>
<span><span class="co">#&gt; 5     site:year 89      87.4  87.5 </span></span>
<span><span class="co">#&gt; 6          year 38.1    37.4  37.3 </span></span>
<span><span class="co">#&gt; 7          site 42.2    40.7  41.7 </span></span>
<span><span class="co">#&gt; 8      Residual  2.66    2.16  2.16</span></span></code></pre></div>
<p>The biggest change in the variance components happens for
<code>gen</code>, which decreases from about 46 to about 9. This is not
particularly surprising. In the full dataset, some of the genotypes were
tested in only a few trials. These genotypes could easily have been
poorly performing or regional check varieties that were not serious
candidates for advancement for further testing. In either case, these
genotypes could have been more variable than the other genotypes in the
data. We are speculating, but based on some degree of personal
experience.</p>
<p>The other thing to note is the similarity of the variance parameters
from models <code>m1</code> and <code>m2</code>. The similarity
strengthens our belief that while model <code>m1</code> failed to
converge, it likely was near the optimum likelihood.</p>
</div>
<div class="section level2">
<h2 id="appendix---infrequently-asked-questions">Appendix - Infrequently Asked Questions<a class="anchor" aria-label="anchor" href="#appendix---infrequently-asked-questions"></a>
</h2>
<div class="section level3">
<h3 id="how-to-extract-the-sorted-axis-tick-labels-from-the-levelplot">1. How to extract the sorted axis tick labels from the
levelplot<a class="anchor" aria-label="anchor" href="#how-to-extract-the-sorted-axis-tick-labels-from-the-levelplot"></a>
</h3>
<p>If you want to extract the sorted axis tick labels, assign the
graphic to an object and extract the components of interest:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/connected/">connected</a></span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">data_fernando</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">dat</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">y</span> <span class="op">~</span> <span class="va">gen</span><span class="op">*</span><span class="va">herd</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in con_view(dat, y ~ gen * herd): There are 2 groups</span></span>
<span><span class="va">tmp</span><span class="op">$</span><span class="va">x.limits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "G6" "G1" "G2" "G7" "G5" "G3" "G4"</span></span>
<span><span class="va">tmp</span><span class="op">$</span><span class="va">y.limits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "H1" "H3" "H2" "H4"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="how-to-create-consistent-axis-tick-labels-across-multiple-datasets">2. How to create consistent axis tick labels across multiple
datasets<a class="anchor" aria-label="anchor" href="#how-to-create-consistent-axis-tick-labels-across-multiple-datasets"></a>
</h3>
<p>A user wanted to have the same axis tick labels across several
different datasets, even though the datasets might have different factor
levels.</p>
<p>First we create two small datasets. Note that only levels
<code>G2</code> and <code>E2</code> are common to both datasets.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dd1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E1"</span>,<span class="st">"E2"</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                  y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G1"</span>,<span class="st">"G2"</span><span class="op">)</span>, each<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                  z1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1.5</span>,<span class="fl">2.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E3"</span>,<span class="st">"E2"</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                  y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G3"</span>,<span class="st">"G2"</span><span class="op">)</span>, each<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                  z2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">3.5</span>,<span class="fl">4.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dd1</span></span>
<span><span class="co">#&gt;    x  y  z1</span></span>
<span><span class="co">#&gt; 1 E1 G1 1.0</span></span>
<span><span class="co">#&gt; 2 E2 G1 2.0</span></span>
<span><span class="co">#&gt; 3 E1 G2 1.5</span></span>
<span><span class="co">#&gt; 4 E2 G2 2.5</span></span>
<span><span class="va">dd2</span></span>
<span><span class="co">#&gt;    x  y  z2</span></span>
<span><span class="co">#&gt; 1 E3 G3 3.0</span></span>
<span><span class="co">#&gt; 2 E2 G3 4.0</span></span>
<span><span class="co">#&gt; 3 E3 G2 3.5</span></span>
<span><span class="co">#&gt; 4 E2 G2 4.5</span></span></code></pre></div>
<p>Next, create a reference dataframe that contains all of the factor
levels from both <code>dd1</code> and <code>dd2</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dd0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dd1</span><span class="op">$</span><span class="va">x</span>, <span class="va">dd2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dd1</span><span class="op">$</span><span class="va">y</span>, <span class="va">dd2</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>Merge the trait values into this dataframe. When plotting, be sure to
use the <code>dropNA=FALSE</code> options so that factor levels without
trait values are kept and use <code>cluster=FALSE</code> to prevent
re-ordering</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dd0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dd0</span>, <span class="va">dd1</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, all.x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dd0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dd0</span>, <span class="va">dd2</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, all.x<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/connected/">connected</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dd0</span>, <span class="va">z1</span> <span class="op">~</span> <span class="va">x</span> <span class="op">*</span> <span class="va">y</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, dropNA<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">"dd1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-34-1.png" width="288" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/con_view.html">con_view</a></span><span class="op">(</span><span class="va">dd0</span>, <span class="va">z2</span> <span class="op">~</span> <span class="va">x</span> <span class="op">*</span> <span class="va">y</span>, cluster<span class="op">=</span><span class="cn">FALSE</span>, dropNA<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">"dd2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_to_the_connected_package_files/figure-html/unnamed-chunk-34-2.png" width="288" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="how-to-view-the-axis-labels-andor-cell-group-numbers-when-there-are-many-levels">3. How to view the axis labels and/or cell group numbers when there
are many levels<a class="anchor" aria-label="anchor" href="#how-to-view-the-axis-labels-andor-cell-group-numbers-when-there-are-many-levels"></a>
</h3>
<p>The best strategy is to send the graphical output to a pdf file and
experiment with the <code>cex</code> arguments of
<code><a href="../reference/con_view.html">con_view()</a></code> to reduce over-plotting. Then open the file in a
good pdf viewer that can zoom and search for text.</p>
</div>
</div>
<div class="section level2">
<h2 id="bibliography">Bibliography<a class="anchor" aria-label="anchor" href="#bibliography"></a>
</h2>
<p>Eccleston, J. and K. Russell (1975). Connectedness and orthogonality
in multi-factor designs. Biometrika, 62, 341-345. <a href="https://doi.org/10.1093/biomet/62.2.341" class="external-link uri">https://doi.org/10.1093/biomet/62.2.341</a></p>
<p>Fernando, Rohan and D. Gianola and M. Grossman (1983). Identifying
All Connected Subsets In A Two-Way Classification Without Interaction.
J. of Dairy Science, 66, 1399-1402. Table 1. <a href="https://doi.org/10.3168/jds.S0022-0302(83)81951-1" class="external-link uri">https://doi.org/10.3168/jds.S0022-0302(83)81951-1</a></p>
<p>Gezan, Salvador A. and Giovanni Galli and Darren Murray (2022).
User’s Manual for ASRtriala v. 1.0.0. Published by VSNi. <a href="https://vsni.co.uk/resources/free-software/asrtriala/" class="external-link uri">https://vsni.co.uk/resources/free-software/asrtriala/</a></p>
<p>Piepho, Hans-Peter. (1994) Missing observations in the analysis of
stability. Heredity, 72, 141–145. <a href="https://doi.org/10.1038/hdy.1994.20" class="external-link uri">https://doi.org/10.1038/hdy.1994.20</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Wright.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
